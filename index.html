<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Responsividade e safe areas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Unity Web Player | IFVetores</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="stylesheet" href="assets/overlay.css">

    <!-- Script para gerenciar overlay -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('content-container');
        const inner = document.getElementById('content-inner');
        const closeBtn = document.getElementById('content-close-btn');

        // Função para exibir overlay em fullscreen com conteúdo dinâmico
        function ShowSimulationOverlay() {
          const overlay = document.getElementById('content-container');
          const inner = document.getElementById('content-inner');

          if (!overlay || !inner) return;

          // Limpa o conteúdo e reseta o scroll
          inner.innerHTML = '';
          overlay.scrollTop = 0;

          // Carrega o conteúdo dinâmico
          fetch('assets/content.html', { cache: 'no-cache' })
            .then(resp => resp.ok ? resp.text() : Promise.reject(resp.status))
            .then(html => {
              inner.innerHTML = html;
              overlay.style.display = 'flex';

              // Aguarda renderização antes de tentar fullscreen
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

                  // Evita fullscreen automático em dispositivos móveis
                  if (!isMobile && overlay.requestFullscreen) {
                    overlay.requestFullscreen().catch(err =>
                      console.warn('Erro ao entrar em fullscreen:', err)
                    );
                  }
                });
              });
            })
            .catch(err => console.error('Erro ShowSimulationOverlay:', err));
        }

        // Botão para fechar overlay e ativar fullscreen do Unity Canvas com repaint
        closeBtn.addEventListener('click', () => {
          inner.innerHTML = '';

          const unityCanvas = document.getElementById('unity-canvas');
          if (unityCanvas.requestFullscreen) {
            unityCanvas.requestFullscreen().then(() => {
              // Força repaint no canvas após fullscreen
              setTimeout(() => {
                unityCanvas.style.transform = 'scale(1.001)';
                setTimeout(() => unityCanvas.style.transform = 'scale(1)', 50);
              }, 100);
            }).catch(err =>
              console.warn('Erro ao entrar em fullscreen:', err)
            );
          }

          setTimeout(() => overlay.style.display = 'none', 300);
        });

        window.ShowSimulationOverlay = ShowSimulationOverlay;

        // Garante que o overlay seja o primeiro elemento visível ao carregar
        overlay.style.display = 'flex';
        ShowSimulationOverlay();
      });
    </script>
  </head>

  <body>
    <!-- Overlay para exibição de conteúdo externo -->
    <div id="content-container" class="overlay" style="display:flex;">
      <button id="content-close-btn" class="overlay-close">×</button>
      <div id="content-inner"></div>
    </div>

    <!-- Container principal do Unity -->
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">IFVetores</div>
      </div>
    </div>

    <!-- Script de inicialização do Unity -->
    <script>
      var canvas = document.querySelector("#unity-canvas");
      window.unityInstance = null;

      // Função para exibir mensagens do Unity
      function unityShowBanner(msg, type) {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type === 'error') div.style.background = 'red';
        else if (type === 'warning') {
          div.style.background = 'yellow';
          setTimeout(() => {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      // Configurações e carregamento do Unity
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/IF_web_simualadorVetores.loader.js";
      var config = {
        arguments: [],
        dataUrl: buildUrl + "/IF_web_simualadorVetores.data",
        frameworkUrl: buildUrl + "/IF_web_simualadorVetores.framework.js",
        codeUrl: buildUrl + "/IF_web_simualadorVetores.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "IFVetores",
        productVersion: "1.0",
        showBanner: unityShowBanner
      };

      var unityScript = document.createElement('script');
      unityScript.src = loaderUrl;
      unityScript.onload = function() {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector('#unity-progress-bar-full').style.width = (100 * progress) + '%';
        }).then((instance) => {
          window.unityInstance = instance;
          document.querySelector('#unity-loading-bar').style.display = 'none';
          document.querySelector('#unity-fullscreen-button').onclick = () => {
            canvas.requestFullscreen().catch(() => {});
          };
        }).catch((err) => {
          console.error(err);
          alert('Erro ao iniciar Unity: ' + err);
        });
      };
      document.body.appendChild(unityScript);
    </script>
  </body>
</html>